<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: components/panes/FileEvidencePane.jsx</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: components/panes/FileEvidencePane.jsx</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import React, {
  useCallback,
  useContext,
  useEffect,
  useMemo,
  useState,
} from "react";
import { WithContext as ReactTags, SEPARATORS } from "react-tag-input";

import {
  EvidenceFile,
  EvidencePaneProps,
  GoogleFile,
  TagsPerEvidenceRecord,
} from "../../types";
import { getJsonSortedString, getOccurenceNumber } from "../../../../util";

import useOAuthAPI from "../../hooks/useOAuthAPI";
import { AllTagsContext } from "../../contexts/AllTagsContext";

/**
 * A pane to show in a modal dialog to add files from Google Drive as evidence to a widget item.
 * @param {EvidencePaneProps} props The object containing the props.
 * @returns {React.JSX.Element} The rendered pane.
 * @example &lt;FileEvidencePane evidence={[...]} containerModalId="" allTagsUpdated={() => {}}
 */
const FileEvidencePane = ({
  evidence,
  containerModalId,
  addFileFunc,
  removeFileFunc,
  allTagsUpdated,
  deleteTrendFunc,
  addTrendFunc,
  updateTrendNameFunc,
}) => {
  const ADD_FILES_DIALOG_ID = `addFilesModal: ${containerModalId}`;

  /**
   * A convenience function to sort strings in an array.
   * @param {string} a The first item to compare to the second.
   * @param {string} b The second item to compare to the first.
   * @returns {number} Positive if a should come first, negative if b, and 0 if they are the same.
   * @example sortString("asdf", "basdf") === 1
   */
  const sortString = (a, b) => {
    if (a &lt; b) {
      return 1;
    }
    if (b &lt; a) {
      return -1;
    }
    return 0;
  };

  /**
   * @type {[TagsPerEvidenceRecord | undefined, React.Dispatch&lt;TagsPerEvidenceRecord | undefined>]}
   */
  const [tagsPerFile, setTagsPerFile] = useState();

  /**
   * @type {[EvidenceFile[] | undefined, React.Dispatch&lt;EvidenceFile[]>]}
   */
  const [files, setFiles] = useState(evidence);

  /**
   * @type {[GoogleFile[] | undefined, React.Dispatch&lt;GoogleFile[] | undefined>]}
   */
  const [googleFiles, setGoogleFiles] = useState();

  /**
   * @type {[HTMLDialogElement | undefined, React.Disptch&lt;HTMLDialogElement | undefined>]}
   */
  const [addFilesModal, setAddFilesModal] = useState();

  // set addFilesModal once it exists
  useEffect(() => {
    if (document.getElementById(ADD_FILES_DIALOG_ID) &amp;&amp; !addFilesModal) {
      setAddFilesModal(document.getElementById(ADD_FILES_DIALOG_ID));
    }
  });

  /**
   * @type {[GoogleFile[] | undefined, React.Dispatch&lt;GoogleFile[] | undefined>]}
   */
  const [filteredGoogleFiles, setFilteredGoogleFiles] = useState();

  const { getGoogleDriveFiles } = useOAuthAPI();

  const accessToken = useMemo(() => sessionStorage.getItem("access_token"), []);

  const allTags = useContext(AllTagsContext);

  // update tagsPerFile based on className changes on the summary pane (in allTags)
  useEffect(() => {
    if (allTags &amp;&amp; tagsPerFile) {
      let thereAreChanges = false;
      evidence.forEach((file) => {
        tagsPerFile[file.url].forEach((tag) => {
          const allTagsTag = allTags.find((t) => t.id === tag.id);
          if (allTagsTag &amp;&amp; tag.className !== allTagsTag.className) {
            tag.className = allTagsTag.className;
            const trend = file.trends.find((t) => t.name === tag.id);
            if (trend) {
              trend.type = tag.className;
            } else {
              console.error("*** trend not found in evidence: ", tag.id);
            }
            thereAreChanges = true;
          }
        });
      });
      if (thereAreChanges) {
        // TODO: try to avoid one more re-render/re-evaluation of this effect after making this change
        setTagsPerFile({ ...tagsPerFile });
      }
    }
  }, [allTags, tagsPerFile]);

  useEffect(() => {
    if (accessToken &amp;&amp; !googleFiles) {
      const encodedToken = encodeURI(accessToken);
      getGoogleDriveFiles(encodedToken).then((files) => {
        const filteredFiles = files
          .filter(
            (file) =>
              evidence
                .map(function (f) {
                  return f.url;
                })
                .indexOf(file.alternateLink) === -1
          )
          .sort((a, b) => new Date(b.createdDate) - new Date(a.createdDate));
        setGoogleFiles([...filteredFiles]);
        setFilteredGoogleFiles([...filteredFiles]);
      });
    }
  }, [accessToken, googleFiles]);

  useEffect(() => {
    const initialTags = evidence.reduce((trendsMap, file) => {
      if (!trendsMap[file.url]) {
        if (file.trends) {
          trendsMap[file.url] = file.trends.map((trend) => ({
            id: trend.name,
            text: trend.name,
            className: trend.type,
          }));
        } else {
          trendsMap[file.url] = [];
        }
      }
      return trendsMap;
    }, {});
    setTagsPerFile(initialTags);
  }, []);

  // update allTags and evidence on the server if there are changes: edited tags, deleted tags
  useEffect(() => {
    if (tagsPerFile) {
      let thereAreChangesToTrends = false;

      Object.keys(tagsPerFile).forEach((fileUrl) => {
        const evidenceFile = evidence.find((file) => file.url === fileUrl);
        const tags = tagsPerFile[fileUrl];
        if (tags &amp;&amp; tags.length > 0) {
          const trends = tags.map((tag) => ({
            name: tag.id,
            type: tag.className,
          }));
          if (
            getJsonSortedString(evidenceFile.trends) !==
            getJsonSortedString(trends)
          ) {
            evidenceFile.trends = trends;
            thereAreChangesToTrends = true;
          }
        }
      });
      if (thereAreChangesToTrends) {
        const flatTags = getFlatTagsWithCountsFromTagsPerFile(tagsPerFile);
        allTagsUpdated(flatTags);
      }
    }
  }, [tagsPerFile]);

  /**
   * A function to open a modal dialog on top of the base modal to select files from Google Drive.
   * @example &lt;Component onClick={() => openFilesModal()} />
   */
  const openFilesModal = () => {
    if (addFilesModal) {
      addFilesModal.addEventListener("click", (event) => {
        if (event.target === event.currentTarget) {
          addFilesModal.close();
        }
      });
      addFilesModal.showModal();
    }
  };

  const addFile = useCallback(
    /**
     * A function to add a specified file to a widget item's evidence.
     * @param {GoogleFile} file The gdrive file to add as evidence.
     * @param {React.ChangeEvent&lt;HTMLInputElement>} event The event called on &lt;input> change
     * @example &lt;Component onClick={() => addFile(...)} />
     */
    async (file, event) => {
      const checkbox = event.target;
      if (checkbox.checked) {
        var newFile = {
          name: file.title,
          url: file.alternateLink,
          icon: file.iconLink,
          created_date: file.createdDate,
          modified_date: file.modifiedDate,
        };
        evidence.push(newFile);
        addFileFunc(newFile);
        tagsPerFile[newFile.url] = [];
        setTagsPerFile({ ...tagsPerFile });

        const newFiles = googleFiles.filter(
          (f) => f.alternateLink !== file.alternateLink
        );
        setGoogleFiles(newFiles);

        document.getElementById("fileFilter").value = "";
        setFilteredGoogleFiles(newFiles);
        addFilesModal.close();
      }
    },
    [googleFiles]
  );

  /**
   * A function to remove a file from a widget item's evidence.
   * @param {EvidenceFile} file The file to remove.
   * @example &lt;DeleteButton onClick={() => removeFile(...)} />
   */
  const removeFile = async (file) => {
    const fileIndex = evidence.indexOf((f) => f.url === file.url);
    evidence.splice(fileIndex, 1);
    await removeFileFunc(file.id);
    setFiles(files.filter((f) => f.url !== file.url));
    const newGoogleFiles = [...googleFiles, file];
    setGoogleFiles(newGoogleFiles);
    document.getElementById("fileFilter").value = "";
  };

  const getFlatTagsWithCountsFromTagsPerFile = useCallback(() => {
    /**
     * @type {ReactTags.Tag[]}
     */
    const newAllTags = [];
    /**
     * @type {{[key: string]: {count: number, className: string}}}
     */
    const tagDataMap = {};
    Object.keys(tagsPerFile).forEach((fileUrl) => {
      const fileTags = JSON.parse(JSON.stringify(tagsPerFile[fileUrl]));
      fileTags.forEach((tag) => {
        if (!tagDataMap[tag.id]) {
          tagDataMap[tag.id] = {
            count: 0,
            className: tag.className,
          };
        }
        tagDataMap[tag.id].count += 1;
      });
    });
    Object.keys(tagDataMap).forEach((tagId) => {
      const tagData = tagDataMap[tagId];
      newAllTags.push({
        id: tagId,
        text: `${tagId} (${tagData.count})`,
        className: tagData.className,
      });
    });
    return newAllTags
      .sort(sortString)
      .sort((a, b) => getOccurenceNumber(b.text) - getOccurenceNumber(a.text));
  }, [tagsPerFile]);

  return (
    &lt;>
      &lt;h2>
        &lt;a style={{ cursor: "pointer" }} onClick={() => openFilesModal()}>
          Add File
        &lt;/a>
      &lt;/h2>
      &lt;table className="table">
        &lt;tbody>
          {files &amp;&amp;
            files.map((file) => (
              &lt;tr key={`Item evidence: ${file.url} `}>
                &lt;td>
                  &lt;span
                    className="remove-evidence bi bi-trash"
                    style={{ cursor: "pointer" }}
                    onClick={() => {
                      if (confirm("Are you sure?")) {
                        removeFile(file);
                      }
                    }}
                  >&lt;/span>
                &lt;/td>
                &lt;td>
                  {file.modifiedDate &amp;&amp;
                    new Date(file.modifiedDate).toLocaleDateString()}
                &lt;/td>
                &lt;td>
                  &lt;a href={file.url} target="_blank" rel="noreferrer">
                    &lt;img src={file.icon} />
                    {file.name}
                  &lt;/a>
                &lt;/td>
                &lt;td>
                  {tagsPerFile &amp;&amp; tagsPerFile[file.url] &amp;&amp; (
                    &lt;ReactTags
                      tags={tagsPerFile[file.url]}
                      separators={[SEPARATORS.ENTER]}
                      allowAdditionFromPaste={false}
                      handleAddition={(tag) => {
                        const fileTags = [...tagsPerFile[file.url]];
                        fileTags.push(tag);
                        setTagsPerFile({
                          ...tagsPerFile,
                          [file.url]: fileTags,
                        });
                        addTrendFunc(file.id, {
                          name: tag.id,
                        });
                      }}
                      // suggestions={allTags
                      //   .filter(
                      //     (tag) =>
                      //       trendTagsPerFile[file.url] &amp;&amp;
                      //       !trendTagsPerFile[file.url]
                      //         .map((t) => t.id)
                      //         .includes(tag.id)
                      //   )
                      //   .map((allTag) => ({
                      //     id: allTag.id,
                      //     text: allTag.id,
                      //     className: allTag.className,
                      //   }))}
                      // renderSuggestion={(item, query) => {}}
                      editable={true}
                      onTagUpdate={(index, tag) => {
                        const fileTags = [...tagsPerFile[file.url]];
                        fileTags[index] = {
                          id: tag.id.charAt(0).toUpperCase() + tag.id.slice(1),
                          text:
                            tag.text.charAt(0).toUpperCase() +
                            tag.text.slice(1),
                          className: fileTags[index].className,
                        };
                        const trend = file.trends[index];
                        updateTrendNameFunc(file.id, {
                          id: trend.id,
                          name: tag.id,
                        });
                        setTagsPerFile({
                          ...tagsPerFile,
                          [file.url]: fileTags,
                        });
                      }}
                      placeholder="Add a trend"
                      classNames={{
                        tag: "trendItem",
                        remove: "removeButton",
                      }}
                      allowUnique={true}
                      inputFieldPosition="top"
                      removeComponent={({ className, onRemove }) => {
                        return (
                          &lt;button onClick={onRemove} className={className}>
                            X
                          &lt;/button>
                        );
                      }}
                      handleDelete={(index) => {
                        const trend = file.trends[index];
                        deleteTrendFunc(file.id, trend.id);
                        const thisFileTrends = tagsPerFile[file.url];
                        thisFileTrends.splice(index, 1);
                        setTagsPerFile({
                          ...tagsPerFile,
                          [file.url]: tagsPerFile[file.url],
                        });
                      }}
                    />
                  )}
                &lt;/td>
              &lt;/tr>
            ))}
        &lt;/tbody>
      &lt;/table>
      &lt;dialog
        id={ADD_FILES_DIALOG_ID}
        style={{ width: "600px", height: "600px" }}
      >
        &lt;div className="modal-content">
          &lt;div className="modal-header">
            &lt;h5>Add File to Evidence&lt;/h5>
          &lt;/div>
          &lt;div className="modal-body">
            {/* &lt;div ng-show="loading" style={{ textAlign: "center" }}>
              &lt;img src="ajax-loader.gif" width="32" height="32" />
            &lt;/div> */}
            {googleFiles &amp;&amp; (
              &lt;input
                type="text"
                id="fileFilter"
                placeholder="Search files..."
                style={{ width: "100%" }}
                onChange={(event) => {
                  setFilteredGoogleFiles(
                    googleFiles.filter((file) =>
                      file.title
                        .toLocaleLowerCase()
                        .includes(event.target.value.toLocaleLowerCase())
                    )
                  );
                }}
              />
            )}
            &lt;div id="files">
              &lt;table className="table">
                &lt;tbody>
                  {filteredGoogleFiles &amp;&amp;
                    filteredGoogleFiles.map((file) => (
                      &lt;tr key={`file #${file.alternateLink}`}>
                        &lt;td style={{ width: "100px" }}>
                          &lt;input
                            type="checkbox"
                            onChange={(event) => addFile(file, event)}
                          />
                        &lt;/td>
                        &lt;td className="file">
                          &lt;a
                            href={file.alternateLink}
                            target="_blank"
                            rel="noreferrer"
                          >
                            &lt;img src={file.iconLink} />
                            {file.title}
                          &lt;/a>
                        &lt;/td>
                      &lt;/tr>
                    ))}
                &lt;/tbody>
              &lt;/table>
            &lt;/div>
          &lt;/div>
          &lt;div className="modal-footer">
            &lt;button
              type="button"
              className="btn-primary"
              onClick={() => addFilesModal.close()}
              aria-label="Close"
            >
              Close
            &lt;/button>
          &lt;/div>
        &lt;/div>
      &lt;/dialog>
    &lt;/>
  );
};

export default FileEvidencePane;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#AddPersonaPane">AddPersonaPane</a></li><li><a href="global.html#AllTagsContext">AllTagsContext</a></li><li><a href="global.html#App">App</a></li><li><a href="global.html#Dashboard">Dashboard</a></li><li><a href="global.html#EmpathyMapPane">EmpathyMapPane</a></li><li><a href="global.html#EvidencePaneContext">EvidencePaneContext</a></li><li><a href="global.html#FileEvidencePane">FileEvidencePane</a></li><li><a href="global.html#JourneyMapPane">JourneyMapPane</a></li><li><a href="global.html#MarketResearchWidget">MarketResearchWidget</a></li><li><a href="global.html#Modal">Modal</a></li><li><a href="global.html#StakeholderEvidencePane">StakeholderEvidencePane</a></li><li><a href="global.html#StakeholderResearchWidget">StakeholderResearchWidget</a></li><li><a href="global.html#StoriesWidget">StoriesWidget</a></li><li><a href="global.html#SummaryPaneContext">SummaryPaneContext</a></li><li><a href="global.html#TodoWidget">TodoWidget</a></li><li><a href="global.html#Widget">Widget</a></li><li><a href="global.html#WidgetItemRow">WidgetItemRow</a></li><li><a href="global.html#formatTrendTypeText">formatTrendTypeText</a></li><li><a href="global.html#useCollectionAPI">useCollectionAPI</a></li><li><a href="global.html#useCollectionItems">useCollectionItems</a></li><li><a href="global.html#useEvidenceAPI">useEvidenceAPI</a></li><li><a href="global.html#useOAuthAPI">useOAuthAPI</a></li><li><a href="global.html#useProductAPI">useProductAPI</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.3</a> on Sat Aug 31 2024 15:59:11 GMT-0400 (Eastern Daylight Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
